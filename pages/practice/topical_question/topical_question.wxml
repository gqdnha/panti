<view class="container">
    <!-- æ•°æ®ä¸ºç©ºæ—¶æ˜¾ç¤º -->
    <view class="no-data-container" wx:if="{{noData}}">
        <view class="no-data-icon">ğŸ“</view>
        <view class="no-data-text">æš‚æ— é¢˜ç›®æ•°æ®</view>
        <view class="no-data-tip">è¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜</view>
    </view>

    <!-- æœ‰æ•°æ®æ—¶æ˜¾ç¤ºæ­£å¸¸å†…å®¹ -->
    <view wx:if="{{!noData && totalQuestions > 0}}" class="content-wrapper">
        <!-- é¡¶éƒ¨è¿›åº¦æ¡ -->
        <view class="progress-bar">
            <view class="progress-info">
                <text>ç¬¬{{currentQuestion}}/{{totalQuestions}}é¢˜</text>
                <text>å­¦ä¹ æ—¶é•¿ï¼š{{studyTime}}åˆ†é’Ÿ</text>
            </view>
            <!-- è¿›åº¦æ¡ -->
            <view class="progress-track">
                <view class="progress-fill" style="width: {{(currentQuestion/totalQuestions)*100}}%"></view>
            </view>
        </view>

        <!-- å¯æ»šåŠ¨çš„å†…å®¹åŒºåŸŸ -->
        <scroll-view scroll-y class="scroll-content">
        <!-- é¢˜ç›®å†…å®¹ -->
        <view class="question-container">
            <view class="question-type">{{questionList[currentQuestion - 1].type}}</view>
            <view class="question-content">
                <text>{{currentQuestion}}.{{questionList[currentQuestion - 1].content}}</text>
                
                <!-- å›¾ç‰‡æ˜¾ç¤ºåŒºåŸŸ -->
                <block wx:if="{{questionList[currentQuestion - 1].if_picture}}">
                    <view class="question-images">
                        <block wx:for="{{parsedImageList[currentQuestion - 1]}}" wx:key="id">
                            <image 
                                wx:if="{{item.image_url}}"
                                src="https://gqdnha.cn:8090/static/{{item.image_url}}"
                                mode="widthFix"
                                class="question-image"
                                bindtap="previewImage"
                                data-url="https://gqdnha.cn:8090/static/{{item.image_url}}"
                                lazy-load="true"
                            />
                        </block>
                    </view>
                </block>
            </view>

            <!-- é€‰é¡¹åŒºåŸŸ -->
            <view class="options-container">
                <!-- å•é€‰é¢˜ -->
                <block wx:if="{{questionList[currentQuestion - 1].type === 'å•é€‰é¢˜'}}">
                    <view class="option-item {{selectedOptions[currentQuestion - 1] === item[0]? (questionStates[currentQuestion - 1]? 'selected correct' : (isSubmitted[currentQuestion - 1]? 'selected wrong' :'selected')) : ''}}" wx:for="{{questionList[currentQuestion - 1].options}}" wx:key="index" bindtap="selectOption" data-index="{{index}}">
                        <text class="option-content">{{item}}</text>
                        <text class="option-status" wx:if="{{isSubmitted[currentQuestion - 1]}}">
                            <text wx:if="{{item[0] === detailData.answer}}" class="status-icon correct">âœ“</text>
                            <text wx:elif="{{selectedOptions[currentQuestion - 1] === item[0] && item[0] !== detailData.answer}}" class="status-icon wrong">Ã—</text>
                        </text>
                    </view>
                </block>

                <!-- å¤šé€‰é¢˜ -->
                <block wx:if="{{questionList[currentQuestion - 1].type === 'å¤šé€‰é¢˜'}}">
                    <view wx:for="{{questionList[currentQuestion - 1].options}}"
                          wx:key="index"
                          class="option-item {{optionStates[currentQuestion - 1][index] ? (questionStates[currentQuestion - 1] ? 'selected correct' : (isSubmitted[currentQuestion - 1] ? 'selected wrong' : 'selected')) : ''}}"
                          bindtap="selectMultipleOption"
                          data-index="{{index}}">
                        <text class="option-content">{{item}}</text>
                        <text class="option-status" wx:if="{{isSubmitted[currentQuestion - 1]}}">
                            <text wx:if="{{detailData.answer.includes(item[0])}}" class="status-icon correct">âœ“</text>
                            <text wx:elif="{{selectedOptions[currentQuestion - 1].includes(item[0]) && !detailData.answer.includes(item[0])}}" class="status-icon wrong">Ã—</text>
                        </text>
                    </view>
                </block>

                <!-- åˆ¤æ–­é¢˜ -->
                <block wx:if="{{questionList[currentQuestion - 1].type === 'åˆ¤æ–­é¢˜'}}">
                    <view class="option-item {{selectedOptions[currentQuestion - 1] === item[0]? (questionStates[currentQuestion - 1]? 'selected correct' : (isSubmitted[currentQuestion - 1]? 'selected wrong' :'selected')) : ''}}" wx:for="{{questionList[currentQuestion - 1].options}}" wx:key="index" bindtap="selectOption" data-index="{{index}}">
                        <text class="option-content">{{item}}</text>
                        <text class="option-status" wx:if="{{isSubmitted[currentQuestion - 1]}}">
                            <text wx:if="{{item[0] === detailData.answer}}" class="status-icon correct">âœ“</text>
                            <text wx:elif="{{selectedOptions[currentQuestion - 1] === item[0] && item[0] !== detailData.answer}}" class="status-icon wrong">Ã—</text>
                        </text>
                    </view>
                </block>

                <!-- å¡«ç©ºé¢˜ -->
                <block class="testCard" wx:if="{{questionList[currentQuestion - 1].type === 'å¡«ç©ºé¢˜'}}">
                    <input class="fill-blank-input {{questionStates[currentQuestion - 1]? 'correct' : (isSubmitted[currentQuestion - 1]? 'wrong' : '')}}" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" value="{{answer}}" bindinput="onInputAnswer" />
                </block>
            </view>

            <!-- æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º -->
            <view class="correct-answer-section" wx:if="{{isSubmitted[currentQuestion - 1]}}">
                <view class="correct-answer">
                    <text>æ­£ç¡®ç­”æ¡ˆï¼š{{detailData.answer}}</text>
                </view>
            </view>

            <!-- ç­”æ¡ˆè§£æ -->
            <view class="analysis-section" wx:if="{{isSubmitted[currentQuestion - 1]}}">
                <view class="analysis-content">
                    <text class="analysis-title">è§£æï¼š</text>
                    <text>{{detailData.analysis}}</text>
                </view>
            </view>

            <!-- æ¯é“é¢˜çš„æäº¤æŒ‰é’® -->
            <view class="btn submit" bindtap="submitSingleAnswer" wx:if="{{!isSubmitted[currentQuestion - 1]}}">æäº¤ç­”æ¡ˆ</view>
        </view>
        </scroll-view>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <view class="bottom-bar">
            <view class="btn next" bindtap="nextQuestion" wx:if="{{currentQuestion < totalQuestions}}">ä¸‹ä¸€é¢˜</view>
        </view>

        <!-- ç­”æ¡ˆè§£æå¼¹çª— -->
        <view class="analysis-modal" wx:if="{{showAnalysis}}">
            <view class="modal-content">
                <view class="result-header">
                    <text class="{{questionStates[currentQuestion - 1]? 'correct' : 'wrong'}}">
                        {{questionStates[currentQuestion - 1]? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯'}}
                    </text>
                </view>
                <view class="correct-answer">
                    <text>æ­£ç¡®ç­”æ¡ˆï¼š{{questionList[currentQuestion - 1].right_answer}}</text>
                </view>
                <view class="analysis-content">
                    <text class="analysis-title">è§£æï¼š</text>
                    <text>{{questionList[currentQuestion - 1].question_explanation}}</text>
                </view>
                <view class="modal-btns">
                    <view class="btn" bindtap="closeAnalysisAndContinue">ç»§ç»­ç­”é¢˜</view>
                </view>
            </view>
        </view>

        <!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— -->
        <view class="image-preview-modal {{showImagePreview ? 'show' : ''}}" bindtap="closeImagePreview">
            <view class="modal-content" catchtap="stopPropagation">
                <image 
                    class="preview-image" 
                    src="{{currentPreviewImage}}" 
                    mode="aspectFit"
                    bindtouchstart="touchStart"
                    bindtouchmove="touchMove"
                    bindtouchend="touchEnd"
                    style="transform: scale({{scale}}); transition: {{transition}};"
                />
                <view class="close-btn" bindtap="closeImagePreview">Ã—</view>
            </view>
        </view>
    </view>
</view>